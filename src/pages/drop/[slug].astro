---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { sanityClient, urlFor } from "../../lib/sanity";
import { ArrowUpRight } from "lucide-react";

export async function getStaticPaths() {
  const drops = await sanityClient.fetch(`
    *[_type == "drop"]{
      slug,
      title,
      publishedAt,
      coverImage,
      editorial,
      "featuredPosts": featuredPosts[]->{
        title,
        slug,
        mainImage,
        excerpt,
        publishedAt,
        format
      },
      "newsDigest": newsDigest[]->{
        title,
        link,
        source,
        description,
        tags
      }
    }
  `);

  return drops.map((drop: any) => ({
    params: { slug: drop.slug.current },
    props: { drop },
  }));
}

interface Props {
  drop: any;
}

const { drop } = Astro.props;

// Prepara description para meta tags
const description = drop.editorial
  ? drop.editorial.substring(0, 160) +
    (drop.editorial.length > 160 ? "..." : "")
  : `Edição ${drop.title} do Mixtape252`;

// Extrai número da edição do título (ex: "Vol. 01" -> "01")
const volumeNumber = drop.title.match(/\d+/)?.[0] || "X";

// Helper function for format styling
function getFormatStyle(format: string) {
  switch (format) {
    case "news":
      return { label: "#NEWS", color: "bg-yellow-400 text-black" };
    case "review":
      return { label: "#REVIEW", color: "bg-purple-600 text-white" };
    case "interview":
      return { label: "#ENTREVISTA", color: "bg-blue-600 text-white" };
    case "article":
    default:
      return { label: "#ORIGINAL", color: "bg-safety-orange text-white" };
  }
}

// Função para calcular classes de rotação sutil (sem sobreposição)
function getCollageClasses(index: number) {
  const classes: string[] = [];

  // Rotação variável: par = rotate-1, ímpar = -rotate-1, primeiro = sem rotação base
  // Post 1 (index === 1) mantém sua rotação especial de rotate-2, então não aplicamos rotação padrão aqui
  if (index > 0 && index !== 1) {
    if (index % 2 === 0) {
      classes.push("md:rotate-1");
    } else {
      classes.push("md:-rotate-1");
    }
  }

  return classes.join(" ");
}
---

<BaseLayout title={`${drop.title} // MIXTAPE252`} description={description}>
  <article class="min-h-screen bg-paper text-ink overflow-x-hidden">
    <!-- Header: THE DROP Massivo + Adesivo VOL.X -->
    <header
      class="relative w-full min-h-[60vh] md:min-h-[80vh] bg-ink text-paper flex items-center justify-center p-8 md:p-16 border-b-4 border-ink overflow-hidden"
    >
      {
        drop.coverImage && (
          <div class="absolute inset-0 opacity-20">
            <img
              src={urlFor(drop.coverImage)
                .width(1920)
                .height(1080)
                .fit("crop")
                .url()}
              alt={drop.title}
              class="w-full h-full object-cover grayscale contrast-150"
            />
          </div>
        )
      }

      <div class="relative z-10 text-center">
        <!-- Título Principal: THE DROP -->
        <h1
          class="text-7xl md:text-9xl lg:text-[12rem] font-headline uppercase leading-[0.85] tracking-tighter mb-4 transform -rotate-1"
        >
          THE DROP
        </h1>

        <!-- Adesivo VOL.X Rotacionado -->
        <div
          class="absolute top-8 right-8 md:top-16 md:right-16 transform rotate-12 z-20"
        >
          <div
            class="bg-safety-orange text-ink border-4 border-paper px-6 py-3 shadow-hard"
          >
            <span class="font-headline text-3xl md:text-5xl uppercase">
              VOL. {volumeNumber}
            </span>
          </div>
        </div>

        <!-- Data -->
        <div
          class="mt-8 font-mono text-sm md:text-base uppercase tracking-widest opacity-80"
        >
          {
            new Date(drop.publishedAt).toLocaleDateString("pt-BR", {
              day: "2-digit",
              month: "long",
              year: "numeric",
            })
          }
        </div>
      </div>
    </header>

    <!-- Divisor ASCII -->
    <div class="py-4 px-4 text-center border-y-4 border-ink bg-paper">
      <div class="font-mono text-xs md:text-sm tracking-widest text-ink">
        //----------------//----------------//----------------//
      </div>
    </div>

    <!-- Editorial: Manifesto Colado -->
    {
      drop.editorial && (
        <section class="bg-ink text-paper py-12 md:py-16 px-6 md:px-12 border-b-4 border-ink transform rotate-0.5">
          <div class="max-w-4xl mx-auto">
            <div class="font-mono text-base md:text-lg leading-relaxed whitespace-pre-line border-l-4 border-safety-orange pl-6">
              {drop.editorial}
            </div>
          </div>
        </section>
      )
    }

    <!-- Divisor ASCII -->
    <div class="py-4 px-4 text-center border-y-4 border-ink bg-paper">
      <div class="font-mono text-xs md:text-sm tracking-widest text-ink">
        //----------------//----------------//----------------//
      </div>
    </div>

    <!-- Grid de Posts: A Colagem -->
    <section class="py-12 md:py-16 px-4 md:px-8">
      <div class="max-w-7xl mx-auto">
        {
          drop.featuredPosts && drop.featuredPosts.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
              {drop.featuredPosts.map((post: any, index: number) => {
                const style = getFormatStyle(post.format);

                // Post 0: Destaque Grande (col-span-12 md:col-span-8)
                if (index === 0) {
                  return (
                    <a
                      href={`/post/${post.slug.current}?source=${drop.slug.current}`}
                      class={`group col-span-12 md:col-span-8 block relative bg-white border-4 border-ink h-full hover:z-30 hover:scale-[1.02] hover:-rotate-1 transition-all duration-300 shadow-hard hover:shadow-hard-lg overflow-hidden ${getCollageClasses(index)}`}
                    >
                      {post.mainImage ? (
                        <div class="w-full h-[60vh] md:h-[80vh] overflow-hidden relative">
                          <img
                            src={urlFor(post.mainImage)
                              .width(1200)
                              .height(1200)
                              .fit("crop")
                              .url()}
                            alt={post.title}
                            class="w-full h-full object-cover grayscale contrast-125 group-hover:grayscale-0 transition-all duration-500 scale-100 group-hover:scale-110"
                          />
                          <div class="absolute inset-0 bg-gradient-to-t from-ink via-transparent to-transparent" />
                          <div
                            class={`absolute top-0 left-0 ${style.color} text-xs font-bold px-3 py-1 border-r-4 border-b-4 border-ink font-body z-20`}
                          >
                            {style.label}
                          </div>
                        </div>
                      ) : (
                        <div class="w-full h-[60vh] md:h-[80vh] flex items-center justify-center bg-neutral-200 font-mono text-ink text-4xl relative">
                          NO SIGNAL
                          <div
                            class={`absolute top-0 left-0 ${style.color} text-xs font-bold px-3 py-1 border-r-4 border-b-4 border-ink font-body z-20`}
                          >
                            {style.label}
                          </div>
                        </div>
                      )}
                      <div class="absolute bottom-0 left-0 right-0 p-6 md:p-12 bg-ink/90 text-paper overflow-hidden">
                        <div class="font-mono text-xs uppercase mb-2 text-safety-orange">
                          {new Date(post.publishedAt).toLocaleDateString(
                            "pt-BR",
                          )}
                        </div>
                        <h2 class="text-4xl md:text-6xl lg:text-7xl font-headline uppercase leading-[0.85] mb-2 break-words">
                          {post.title}
                        </h2>
                        {post.excerpt && (
                          <p class="font-mono text-sm md:text-base mt-4 line-clamp-2 opacity-90 break-words">
                            {post.excerpt}
                          </p>
                        )}
                      </div>
                    </a>
                  );
                }

                // Post 1: Vertical Rotacionado (col-span-12 md:col-span-4)
                if (index === 1) {
                  return (
                    <a
                      href={`/post/${post.slug.current}?source=${drop.slug.current}`}
                      class={`group col-span-12 md:col-span-4 block relative bg-white border-4 border-ink h-full hover:z-30 hover:scale-[1.02] hover:-rotate-1 transition-all duration-300 shadow-hard hover:shadow-hard-lg md:rotate-2 ${getCollageClasses(index)}`}
                    >
                      {post.mainImage ? (
                        <div class="aspect-[3/4] overflow-hidden relative border-b-4 border-ink">
                          <img
                            src={urlFor(post.mainImage)
                              .width(600)
                              .height(800)
                              .fit("crop")
                              .url()}
                            alt={post.title}
                            class="w-full h-full object-cover grayscale contrast-125 group-hover:grayscale-0 transition-all duration-500 scale-100 group-hover:scale-110"
                          />
                          <div
                            class={`absolute top-0 right-0 ${style.color} text-xs font-mono px-3 py-1 border-b-4 border-l-4 border-ink`}
                          >
                            {style.label}
                          </div>
                        </div>
                      ) : (
                        <div class="aspect-[3/4] flex items-center justify-center bg-neutral-200 font-mono text-ink border-b-4 border-ink relative">
                          NO SIGNAL
                          <div
                            class={`absolute top-0 right-0 ${style.color} text-xs font-mono px-3 py-1 border-b-4 border-l-4 border-ink`}
                          >
                            {style.label}
                          </div>
                        </div>
                      )}
                      <div class="p-5 flex flex-col gap-4 overflow-hidden justify-between h-full">
                        <div>
                          <h3 class="text-xl md:text-2xl font-headline uppercase leading-[0.9] group-hover:text-safety-orange transition-colors break-words line-clamp-3">
                            {post.title}
                          </h3>
                          {post.excerpt && (
                            <p class="font-mono text-xs leading-tight line-clamp-4 border-l-2 border-ink pl-3 break-words mt-2">
                              {post.excerpt}
                            </p>
                          )}
                        </div>
                        <div class="font-mono text-xs uppercase opacity-60">
                          {new Date(post.publishedAt).toLocaleDateString(
                            "pt-BR",
                          )}
                        </div>
                      </div>
                    </a>
                  );
                }

                // Post 2: Texto Apenas, Fundo Preto (col-span-12 md:col-span-6)
                if (index === 2) {
                  return (
                    <a
                      href={`/post/${post.slug.current}?source=${drop.slug.current}`}
                      class={`group col-span-12 md:col-span-6 block relative bg-ink text-safety-orange border-4 border-ink h-full hover:z-30 hover:scale-[1.02] hover:-rotate-1 transition-all duration-300 shadow-hard hover:shadow-hard-lg hover:bg-safety-orange hover:text-ink p-8 md:p-12 flex flex-col justify-center min-h-[300px] overflow-hidden ${getCollageClasses(index)}`}
                    >
                      <div class="flex justify-between items-start mb-4">
                        <div class="font-mono text-xs uppercase opacity-80">
                          {new Date(post.publishedAt).toLocaleDateString(
                            "pt-BR",
                          )}
                        </div>
                        <div
                          class={`text-xs font-bold px-2 py-1 border-2 border-current font-mono uppercase z-10`}
                        >
                          {style.label}
                        </div>
                      </div>

                      <h3 class="text-xl md:text-2xl font-headline uppercase leading-[0.9] mb-4 transform -rotate-1 break-words line-clamp-3">
                        {post.title}
                      </h3>
                      {post.excerpt && (
                        <p class="font-mono text-sm md:text-base leading-relaxed mt-4 opacity-90 break-words line-clamp-5">
                          {post.excerpt}
                        </p>
                      )}
                      <div class="mt-8 pt-4 border-t-2 border-current">
                        <span class="font-mono text-xs uppercase">
                          LER MAIS →
                        </span>
                      </div>
                    </a>
                  );
                }

                // Post 3+: Cards Normais (col-span-12 md:col-span-6)
                return (
                  <a
                    href={`/post/${post.slug.current}?source=${drop.slug.current}`}
                    class={`group col-span-12 md:col-span-6 block relative bg-white border-4 border-ink h-full hover:z-30 hover:scale-[1.02] hover:-rotate-1 transition-all duration-300 shadow-hard hover:shadow-hard-lg hover:bg-safety-orange hover:text-white overflow-hidden ${getCollageClasses(index)}`}
                  >
                    {post.mainImage ? (
                      <div class="aspect-square overflow-hidden relative border-b-4 border-ink">
                        <img
                          src={urlFor(post.mainImage)
                            .width(600)
                            .height(600)
                            .fit("crop")
                            .url()}
                          alt={post.title}
                          class="w-full h-full object-cover grayscale contrast-125 group-hover:grayscale-0 transition-all duration-500 scale-100 group-hover:scale-110"
                        />
                        <div
                          class={`absolute top-0 right-0 ${style.color} text-xs font-mono px-3 py-1 border-b-4 border-l-4 border-ink group-hover:border-white`}
                        >
                          {style.label}
                        </div>
                      </div>
                    ) : (
                      <div class="aspect-square flex items-center justify-center bg-neutral-200 font-mono text-ink border-b-4 border-ink group-hover:bg-safety-orange group-hover:text-white relative">
                        NO SIGNAL
                        <div
                          class={`absolute top-0 right-0 ${style.color} text-xs font-mono px-3 py-1 border-b-4 border-l-4 border-ink group-hover:border-white`}
                        >
                          {style.label}
                        </div>
                      </div>
                    )}
                    <div class="p-6 flex flex-col gap-4 overflow-hidden justify-between h-full">
                      <div>
                        <h3 class="text-xl font-headline uppercase leading-[0.9] group-hover:text-white transition-colors break-words line-clamp-3">
                          {post.title}
                        </h3>
                        {post.excerpt && (
                          <p class="font-mono text-xs md:text-sm leading-tight line-clamp-3 border-l-2 border-ink pl-3 group-hover:border-white break-words mt-2">
                            {post.excerpt}
                          </p>
                        )}
                      </div>
                      <div class="pt-4 flex justify-between items-center">
                        <span class="font-mono text-xs uppercase opacity-60">
                          {new Date(post.publishedAt).toLocaleDateString(
                            "pt-BR",
                          )}
                        </span>
                        <span class="inline-block px-3 py-1 bg-ink text-white font-mono text-xs uppercase group-hover:bg-white group-hover:text-ink transition-colors border-2 border-ink group-hover:border-white">
                          LER MAIS_
                        </span>
                      </div>
                    </div>
                  </a>
                );
              })}
            </div>
          ) : (
            <div class="text-center py-16 border-4 border-ink bg-white p-8 transform rotate-1">
              <p class="font-mono text-xl text-ink">
                Nenhum post selecionado para esta edição.
              </p>
            </div>
          )
        }
      </div>
    </section>

    <!-- RADAR UNDERGROUND (News Digest) -->
    {
      drop.newsDigest && drop.newsDigest.length > 0 && (
        <section class="bg-ink text-paper py-12 md:py-16 px-4 md:px-8 border-t-4 border-paper">
          <div class="max-w-4xl mx-auto">
            <!-- Header Radar -->
            <div class="mb-12 text-center">
              <h2 class="text-3xl md:text-5xl font-headline uppercase inline-block border-b-4 border-safety-orange pb-2 tracking-wide">
                /// RADAR UNDERGROUND (SINAIS RÁPIDOS) ///
              </h2>
            </div>

            <!-- Lista de News -->
            <ul class="space-y-6">
              {drop.newsDigest.map((news: any) => (
                <li class="border-b border-dashed border-gray-600 pb-6 last:border-0 group">
                  <div class="flex flex-col md:flex-row md:items-start gap-2 md:gap-4 justify-between">
                    <div class="flex-grow">
                      <a 
                        href={news.link} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="text-xl md:text-2xl font-headline uppercase hover:text-safety-orange transition-colors inline-flex items-center gap-2"
                      >
                        {news.title}
                        <ArrowUpRight size={20} className="opacity-50 group-hover:opacity-100" />
                      </a>
                      
                      <div class="flex items-center gap-3 mt-1 mb-2">
                        <span class="font-mono text-xs text-gray-400 uppercase">
                          VIA {news.source || "DESCONHECIDO"}
                        </span>
                        {news.tags && news.tags.map((tag: string) => (
                          <span class="text-[10px] uppercase border border-white/30 px-1 py-0.5 rounded-sm opacity-70">
                            {tag}
                          </span>
                        ))}
                      </div>

                      {news.description && (
                        <p class="font-mono text-sm opacity-80 max-w-2xl leading-relaxed">
                          {news.description}
                        </p>
                      )}
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        </section>
      )
    }

    <!-- Divisor ASCII -->
    <div class="py-8 px-4 text-center border-y-4 border-ink bg-ink text-paper">
      <div class="font-mono text-sm md:text-base tracking-widest">
        //----------------//----------------//----------------//
      </div>
    </div>

    <!-- Navegação: Botão Voltar -->
    <section class="py-16 px-4 text-center">
      <a
        href="/"
        class="inline-block px-8 py-4 bg-ink text-paper font-headline uppercase text-2xl md:text-3xl hover:bg-safety-orange hover:text-ink transition-all shadow-hard transform hover:-rotate-1 border-4 border-ink"
      >
        ← VOLTAR PARA O CAOS
      </a>
    </section>
  </article>
</BaseLayout>
